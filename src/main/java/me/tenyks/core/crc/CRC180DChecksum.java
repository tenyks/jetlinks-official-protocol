package me.tenyks.core.crc;

import java.util.zip.Checksum;

/**
 * 基于多项式的CRC签名算法
 * @author v-lizy81
 * @version 1.0.0
 * @date 2024/9/11
 * @since V3.1.0
 */
public class CRC180DChecksum implements Checksum {

    private short val = (short) 0xFFFF;

    @Override
    public void update(int buf) {
        short crcHi = (byte) (0x000000FF & (val >> 8));
        short crcLw = (byte) (0x000000FF & val);

        byte b = (byte) (0x000000FF & (buf >> 24));
        int idx = (crcHi ^ b) & 0xFF;
        crcHi = (byte) (crcLw ^ gabyCRCHi[idx]);
        crcLw = gabyCRCLo[idx];

        b = (byte) (0x000000FF & (buf >> 16));
        idx = (crcHi ^ b) & 0xFF;
        crcHi = (byte) (crcLw ^ gabyCRCHi[idx]);
        crcLw = gabyCRCLo[idx];

        b = (byte) (0x000000FF & (buf >> 8));
        idx = (crcHi ^ b) & 0xFF;
        crcHi = (byte) (crcLw ^ gabyCRCHi[idx]);
        crcLw = gabyCRCLo[idx];

        b = (byte) (0x000000FF & buf);
        idx = (crcHi ^ b) & 0xFF;
        crcHi = (byte) (crcLw ^ gabyCRCHi[idx]);
        crcLw = gabyCRCLo[idx];

        this.val = (short)(0xFFFF & (crcHi << 8) | (crcLw & 0xff));
    }

    @Override
    public void update(byte[] buf, int offset, int len) {
        short crcHi = (short) (0x00FF & (val >> 8));
        short crcLw = (short) (0x00FF & val);

        int end = offset + len;
        for (int i = offset; i < end; i++) {
            int tmp = crcHi ^ buf[i];
            int idx = tmp & 0x00FF;
            crcHi = (short)((crcLw ^ gabyCRCHi[idx]) & 0x00FF);
            crcLw = gabyCRCLo[idx];
        }

        this.val = (short)(0x0000FFFF & (crcHi << 8) + (crcLw & 0x00FF));
    }

    @Override
    public long getValue() {
        return val;
    }

    @Override
    public void reset() {
        val = (short)0xFFFF;
    }

    static final short[] gabyCRCHi = {
            (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x01, (short) 0xc0,
            (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41,
            (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0,
            (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0,
            (short) 0x80, (short) 0x41, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40,
            (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1,
            (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41,
            (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1,
            (short) 0x81, (short) 0x40, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41,
            (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x01, (short) 0xc0,
            (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40,
            (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1,
            (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40,
            (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x01, (short) 0xc0,
            (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40,
            (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0,
            (short) 0x80, (short) 0x41, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40,
            (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x01, (short) 0xc0,
            (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41,
            (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0,
            (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41,
            (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0,
            (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40,
            (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1,
            (short) 0x81, (short) 0x40, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41,
            (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40, (short) 0x01, (short) 0xc0, (short) 0x80, (short) 0x41, (short) 0x01, (short) 0xc0,
            (short) 0x80, (short) 0x41, (short) 0x00, (short) 0xc1, (short) 0x81, (short) 0x40
    };

    static final short[] gabyCRCLo = {
            (short) 0x00, (short) 0xc0, (short) 0xc1, (short) 0x01, (short) 0xc3, (short) 0x03, (short) 0x02, (short) 0xc2, (short) 0xc6, (short) 0x06,
            (short) 0x07, (short) 0xc7, (short) 0x05, (short) 0xc5, (short) 0xc4, (short) 0x04, (short) 0xcc, (short) 0x0c, (short) 0x0d, (short) 0xcd,
            (short) 0x0f, (short) 0xcf, (short) 0xce, (short) 0x0e, (short) 0x0a, (short) 0xca, (short) 0xcb, (short) 0x0b, (short) 0xc9, (short) 0x09,
            (short) 0x08, (short) 0xc8, (short) 0xd8, (short) 0x18, (short) 0x19, (short) 0xd9, (short) 0x1b, (short) 0xdb, (short) 0xda, (short) 0x1a,
            (short) 0x1e, (short) 0xde, (short) 0xdf, (short) 0x1f, (short) 0xdd, (short) 0x1d, (short) 0x1c, (short) 0xdc, (short) 0x14, (short) 0xd4,
            (short) 0xd5, (short) 0x15, (short) 0xd7, (short) 0x17, (short) 0x16, (short) 0xd6, (short) 0xd2, (short) 0x12, (short) 0x13, (short) 0xd3,
            (short) 0x11, (short) 0xd1, (short) 0xd0, (short) 0x10, (short) 0xf0, (short) 0x30, (short) 0x31, (short) 0xf1, (short) 0x33, (short) 0xf3,
            (short) 0xf2, (short) 0x32, (short) 0x36, (short) 0xf6, (short) 0xf7, (short) 0x37, (short) 0xf5, (short) 0x35, (short) 0x34, (short) 0xf4,
            (short) 0x3c, (short) 0xfc, (short) 0xfd, (short) 0x3d, (short) 0xff, (short) 0x3f, (short) 0x3e, (short) 0xfe, (short) 0xfa, (short) 0x3a,
            (short) 0x3b, (short) 0xfb, (short) 0x39, (short) 0xf9, (short) 0xf8, (short) 0x38, (short) 0x28, (short) 0xe8, (short) 0xe9, (short) 0x29,
            (short) 0xeb, (short) 0x2b, (short) 0x2a, (short) 0xea, (short) 0xee, (short) 0x2e, (short) 0x2f, (short) 0xef, (short) 0x2d, (short) 0xed,
            (short) 0xec, (short) 0x2c, (short) 0xe4, (short) 0x24, (short) 0x25, (short) 0xe5, (short) 0x27, (short) 0xe7, (short) 0xe6, (short) 0x26,
            (short) 0x22, (short) 0xe2, (short) 0xe3, (short) 0x23, (short) 0xe1, (short) 0x21, (short) 0x20, (short) 0xe0, (short) 0xa0, (short) 0x60,
            (short) 0x61, (short) 0xa1, (short) 0x63, (short) 0xa3, (short) 0xa2, (short) 0x62, (short) 0x66, (short) 0xa6, (short) 0xa7, (short) 0x67,
            (short) 0xa5, (short) 0x65, (short) 0x64, (short) 0xa4, (short) 0x6c, (short) 0xac, (short) 0xad, (short) 0x6d, (short) 0xaf, (short) 0x6f,
            (short) 0x6e, (short) 0xae, (short) 0xaa, (short) 0x6a, (short) 0x6b, (short) 0xab, (short) 0x69, (short) 0xa9, (short) 0xa8, (short) 0x68,
            (short) 0x78, (short) 0xb8, (short) 0xb9, (short) 0x79, (short) 0xbb, (short) 0x7b, (short) 0x7a, (short) 0xba, (short) 0xbe, (short) 0x7e,
            (short) 0x7f, (short) 0xbf, (short) 0x7d, (short) 0xbd, (short) 0xbc, (short) 0x7c, (short) 0xb4, (short) 0x74, (short) 0x75, (short) 0xb5,
            (short) 0x77, (short) 0xb7, (short) 0xb6, (short) 0x76, (short) 0x72, (short) 0xb2, (short) 0xb3, (short) 0x73, (short) 0xb1, (short) 0x71,
            (short) 0x70, (short) 0xb0, (short) 0x50, (short) 0x90, (short) 0x91, (short) 0x51, (short) 0x93, (short) 0x53, (short) 0x52, (short) 0x92,
            (short) 0x96, (short) 0x56, (short) 0x57, (short) 0x97, (short) 0x55, (short) 0x95, (short) 0x94, (short) 0x54, (short) 0x9c, (short) 0x5c,
            (short) 0x5d, (short) 0x9d, (short) 0x5f, (short) 0x9f, (short) 0x9e, (short) 0x5e, (short) 0x5a, (short) 0x9a, (short) 0x9b, (short) 0x5b,
            (short) 0x99, (short) 0x59, (short) 0x58, (short) 0x98, (short) 0x88, (short) 0x48, (short) 0x49, (short) 0x89, (short) 0x4b, (short) 0x8b,
            (short) 0x8a, (short) 0x4a, (short) 0x4e, (short) 0x8e, (short) 0x8f, (short) 0x4f, (short) 0x8d, (short) 0x4d, (short) 0x4c, (short) 0x8c,
            (short) 0x44, (short) 0x84, (short) 0x85, (short) 0x45, (short) 0x87, (short) 0x47, (short) 0x46, (short) 0x86, (short) 0x82, (short) 0x42,
            (short) 0x43, (short) 0x83, (short) 0x41, (short) 0x81, (short) 0x80, (short) 0x40
    };

}
