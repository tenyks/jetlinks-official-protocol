

# 3. 通信协议报文

## 3.1 设备上下线消息
* 设备端主动上报
* MQTT主题：`qytech/${productID}/${deviceID}/thing/online/post`
* 报文示例
```json
{
  "id": "123",
  "version": "1.0",
  "params": {
    "online": 1
  },
  "method": "thing.online.post"
}
```
其中，`online`字段：0 离线，1 在线，其他备用

## 3.2 上报设备信息
* 设备主动上报
* MQTT主题：`qytech/${productID}/${deviceID}/thing/deviceinfo/post`
* 报文示例：
```json
{
	"id": "123",
	"version": "1.0",
	"params": {
		"version": "3.4.0",
		"littlefs_version": "V1.3.2",
		"deviceId": "BCDDC2575959",
		"ssid": "HBJX",
		"ip": "192.168.0.109",
		"mac": "BC:DD:C2:57:59:59",
		"relay": 0,
		"mode": 6
	},
	"method": "thing.deviceinfo.post"
}
```

## 3.2 读设备信息
* 服务端按需请求
* 下行MQTT主题：`qytech/${productID}/${deviceID}/thing/deviceinfo/get`
* 下行报文示例：
```json
{
  "id": 123,
  "version": "1.0",
  "params": {
    "format": "json"
  },
  "method": "thing.deviceinfo.get"
}
```
* 上行MQTT主题：`qytech/${productID}/${deviceID}/thing/deviceinfo/get_reply`
* 上行报文示例：
```json
{
  "code": 200,
  "data": {
    "version": "3.4.0",
    "littlefs_version": "V1.3.2",
    "deviceId": "BCDDC2575959",
    "ssid": "HBJX",
    "ip": "192.168.0.109",
    "mac": "BC:DD:C2:57:59:59",
    "relay": 0,
    "mode": 6
  },
  "id": "123",
  "message": "success"
}
```

## 3.3 写设备属性
* 服务端按需请求
* 下行MQTT主题：`qytech/${productID}/${deviceID}/thing/property/set`
* 下行报文示例：
```json
{
  "id": "123",
  "version": "1.0",
  "params": {
    "Relay": {
      "value": true
    }
  },
  "method": "thing.property.set"
}
```
* 上行MQTT主题：`qytech/${productID}/${deviceID}/thing/property/set_reply`
* 上行报文示例：
```json
{
  "code": 200,
  "data": {},
  "id": "123",
  "message": "success",
  "method": "thing.property.set",
  "version": "1.0"
}
```

## 3.3 读设备属性
* 服务端按需请求
* 下行MQTT主题：`qytech/${productID}/${deviceID}/thing/property/get`
* 下行报文示例：
```json
{
  "id": "123",
  "version": "1.0",
  "params": {
    "value": "Relay"
  },
  "method": "thing.property.get"
}
```
其中，`value`字段取值：Relay和Power

* 上行MQTT主题：`qytech/${productID}/${deviceID}/thing/property/get_reply`
* 上行报文示例：
```json
{
  "id": "123",
  "version": "1.0",
  "code": 200,
  "data": {
    "Relay": {
      "value": true
    }
  },
  "message": "success",
  "method": "thing.service.property.get"
}
```
```json
{
  "id": "123",
  "version": "1.0",
  "code": 200,
  "data": {
    "Power": {
      "Vol": 230,
      "Current": 5.3500,
      "ActiveP": 1230.50
    },
    "status": 1
  },
  "message": "success",
  "method": "thing.service.property.get"
}
```
其中，`ActiveP`表示功率

# 9. 附录

## 9.1 WIFI配网
* 开机，指示灯亮起后(需要灯闪烁3下后)，需在3s内（超过3s则会正常启动），按一下按键（注：切记按键时长一定要小于3s，建议按一下按键松开即可），则进入wifi配网模式，此时指示灯快闪。
  配网时，热点ap信息如下：
  ```
    ssid:qytech
    password:12345678
    IP address:192.168.4.1
  ```